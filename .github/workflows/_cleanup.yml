name: Cleanup Resources (Reusable)

on:
  workflow_call:
    inputs:
      pr-number:
        required: true
        type: string
    secrets:
      RAILWAY_TOKEN:
        required: true
      RAILWAY_PROJECT_ID:
        required: true

jobs:
  cleanup:
    name: Cleanup PR Resources
    runs-on: ubuntu-latest
    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Delete preview services
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}

          PR_NUM=${{ inputs.pr-number }}
          SERVICES=("php-api" "go-worker" "frontend" "nginx")

          for service in "${SERVICES[@]}"; do
            SERVICE_NAME="pr-${PR_NUM}-${service}"
            echo "Deleting $SERVICE_NAME..."
            railway service "$SERVICE_NAME"
            railway service delete "$SERVICE_NAME" --force || true
          done

          echo "âœ… Cleanup completed for PR #${PR_NUM}"
