name: Deploy to Environment (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: string
      version-tag:
        description: "Image version tag"
        required: true
        type: string
      service:
        description: "Railway service name to deploy"
        required: false
        type: string
        default: ""
      pr-number:
        description: "PR number (if applicable)"
        required: false
        type: string
        default: ""
    secrets:
      RAILWAY_API_TOKEN:
        required: true
      RAILWAY_PROJECT_ID:
        required: true

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
    steps:
      - name: Get service ID
        id: service
        run: |
          echo "Getting service ID for ${{ inputs.service }}..."

          RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
            -d "{\"query\": \"query { project(id: \\\"$RAILWAY_PROJECT_ID\\\") { services { edges { node { id name } } } } }\"}")

          SERVICE_ID=$(echo "$RESPONSE" | grep -o "\"id\":\"[^\"]*\",\"name\":\"${{ inputs.service }}\"" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)

          if [ -z "$SERVICE_ID" ]; then
            echo "❌ Service '${{ inputs.service }}' not found!"
            echo "$RESPONSE"
            exit 1
          fi

          echo "Service ID: $SERVICE_ID"
          echo "service_id=$SERVICE_ID" >> $GITHUB_OUTPUT

      - name: Update service image
        run: |
          echo "========================================"
          echo "Deploying to ${{ inputs.environment }}"
          echo "Version: ${{ inputs.version-tag }}"
          echo "Service: ${{ inputs.service }}"
          echo "========================================"

          # Image URL from GHCR
          IMAGE="ghcr.io/${{ github.repository }}/${{ inputs.service }}:${{ inputs.version-tag }}"
          echo "Image: $IMAGE"

          # Update service to use the new image
          RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
            -d "{\"query\": \"mutation { serviceConnect(id: \\\"${{ steps.service.outputs.service_id }}\\\", input: { image: \\\"$IMAGE\\\" }) { id } }\"}")

          echo "Update response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"errors"'; then
            echo "❌ Failed to update service image!"
            exit 1
          fi

          echo "✅ Service image updated"

      - name: Trigger redeploy
        id: redeploy
        run: |
          echo "Triggering redeploy..."

          # Get environment ID
          ENV_RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
            -d "{\"query\": \"query { project(id: \\\"$RAILWAY_PROJECT_ID\\\") { environments { edges { node { id name } } } } }\"}")

          ENV_ID=$(echo "$ENV_RESPONSE" | grep -o "\"id\":\"[^\"]*\",\"name\":\"${{ inputs.environment }}\"" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)

          echo "Environment ID: $ENV_ID"

          # Redeploy the service
          RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
            -d "{\"query\": \"mutation { serviceInstanceRedeploy(serviceId: \\\"${{ steps.service.outputs.service_id }}\\\", environmentId: \\\"$ENV_ID\\\") }\"}")

          echo "Redeploy response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"errors"'; then
            echo "❌ Failed to trigger redeploy!"
            exit 1
          fi

          echo "✅ Redeploy triggered"

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."

          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Check $ATTEMPT/$MAX_ATTEMPTS..."

            RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
              -d "{\"query\": \"query { service(id: \\\"${{ steps.service.outputs.service_id }}\\\") { deployments(first: 1) { edges { node { status } } } } }\"}")

            STATUS=$(echo "$RESPONSE" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4)
            echo "Status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "✅ Deployment successful!"
              exit 0
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CRASHED" ]; then
              echo "❌ Deployment failed with status: $STATUS"
              exit 1
            fi

            sleep 10
          done

          echo "❌ Deployment timed out"
          exit 1

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ghcr.io/${{ github.repository }}/${{ inputs.service }}:${{ inputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
