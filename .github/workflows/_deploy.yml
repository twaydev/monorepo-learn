name: Deploy to Environment (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: string
      version-tag:
        description: "Image version tag"
        required: true
        type: string
      service:
        description: "Railway service name to deploy"
        required: false
        type: string
        default: ""
      pr-number:
        description: "PR number (if applicable)"
        required: false
        type: string
        default: ""
    secrets:
      RAILWAY_API_TOKEN:
        required: true
      RAILWAY_PROJECT_ID:
        required: true

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
    steps:
      - name: Deploy service with image
        id: deploy
        run: |
          echo "========================================"
          echo "Deploying to ${{ inputs.environment }}"
          echo "Version: ${{ inputs.version-tag }}"
          echo "Service: ${{ inputs.service }}"
          echo "========================================"

          # Install Railway CLI
          npm install -g @railway/cli

          # Image URL from GHCR
          IMAGE="ghcr.io/${{ github.repository }}/${{ inputs.service }}:${{ inputs.version-tag }}"
          echo "Image: $IMAGE"

          # Deploy using Railway CLI
          # This handles service instance creation automatically
          railway deploy \
            --project "$RAILWAY_PROJECT_ID" \
            --environment "${{ inputs.environment }}" \
            --service "${{ inputs.service }}" \
            --image "$IMAGE" \
            --detach || {
              echo "⚠️ Railway CLI deploy failed, may require manual setup"
              echo "Please configure the service in Railway dashboard to use image: $IMAGE"
              exit 1
            }

          echo "✅ Deployment initiated"

      - name: Wait for deployment
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          echo "Waiting for deployment to complete..."

          # Get service ID
          RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
            -d "{\"query\": \"query { project(id: \\\"$RAILWAY_PROJECT_ID\\\") { services { edges { node { id name } } } } }\"}")

          SERVICE_ID=$(echo "$RESPONSE" | grep -o "\"id\":\"[^\"]*\",\"name\":\"${{ inputs.service }}\"" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)

          if [ -z "$SERVICE_ID" ]; then
            echo "⚠️ Could not find service ID, skipping status check"
            exit 0
          fi

          MAX_ATTEMPTS=30
          ATTEMPT=0

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Check $ATTEMPT/$MAX_ATTEMPTS..."

            RESPONSE=$(curl -s -X POST https://backboard.railway.app/graphql/v2 \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $RAILWAY_API_TOKEN" \
              -d "{\"query\": \"query { service(id: \\\"$SERVICE_ID\\\") { deployments(first: 1) { edges { node { status } } } } }\"}")

            STATUS=$(echo "$RESPONSE" | grep -o '"status":"[^"]*"' | head -1 | cut -d'"' -f4)
            echo "Status: $STATUS"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "✅ Deployment successful!"
              exit 0
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CRASHED" ]; then
              echo "❌ Deployment failed with status: $STATUS"
              exit 1
            fi

            sleep 10
          done

          echo "❌ Deployment timed out"
          exit 1

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ghcr.io/${{ github.repository }}/${{ inputs.service }}:${{ inputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
