name: CI - Build Images

on:
  workflow_run:
    workflows: [Trigger Setup]
    types: [completed]

jobs:
  # Load setup outputs
  load-config:
    name: Load Configuration
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      version-tag: ${{ steps.config.outputs.version-tag }}
      should-build: ${{ steps.config.outputs.should-build }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Recalculate (hoặc lưu artifacts từ workflow trước)
      # - id: config
      #   run: |
      #     echo "environment=production" >> $GITHUB_OUTPUT
      #     echo "version-tag=v1.0.0" >> $GITHUB_OUTPUT
      #     echo "should-build=true" >> $GITHUB_OUTPUT

  # Build matrix strategy for multiple services
  build-matrix:
    name: Build ${{ matrix.image-name }}
    needs: load-config
    if: needs.load-config.outputs.should-build == 'true'
    uses: ./.github/workflows/_reusable/build.yml
    permissions:
      packages: write
    strategy:
      matrix:
        include:
          - image-name: php-api
            dockerfile: ./docker/Dockerfile.php-api
            context: .
            platforms: linux/amd64
    with:
      dockerfile: ${{ matrix.dockerfile }}
      image-name: ${{ matrix.image-name }}
      context: ${{ matrix.context }}
      platforms: ${{ matrix.platforms }}
      push: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
      cache-key: ${{ github.ref_name }}
      environment: ${{ needs.load-config.outputs.environment }}
      version-tag: ${{ needs.load-config.outputs.version-tag }}
    secrets: inherit
