name: CI - Build Images

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment (production|staging|preview)"
        required: true
        type: string
      version-tag:
        description: "Version tag for images"
        required: true
        type: string
      branch:
        description: "Branch name"
        required: true
        type: string
      changed-services:
        description: "Comma-separated list of changed services (empty = none, 'all' = build all)"
        required: false
        type: string
        default: ""

jobs:
  prepare-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has-services: ${{ steps.matrix.outputs.has-services }}
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Build matrix from changed services
        id: matrix
        run: |
          SERVICES_FILE=".github/service-matrix.yml"
          CHANGED_SERVICES="${{ inputs.changed-services }}"

          if [ ! -f "$SERVICES_FILE" ]; then
            echo "Error: $SERVICES_FILE not found"
            exit 1
          fi

          # Convert YAML to JSON
          SERVICES_JSON=$(yq eval -o=json "$SERVICES_FILE")

          # If 'all' is passed, build all services
          if [ "$CHANGED_SERVICES" = "all" ]; then
            echo "Building all services"
            MATRIX_JSON=$(echo "$SERVICES_JSON" | jq -c '{include: .services}')
            echo "matrix=${MATRIX_JSON}" >> $GITHUB_OUTPUT
            echo "has-services=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # If empty, no services to build
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "No services to build"
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "has-services=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Filter services based on changed-services list
          FILTERED_SERVICES="[]"

          # Convert comma-separated list to array
          IFS=',' read -ra SERVICE_ARRAY <<< "$CHANGED_SERVICES"

          for SERVICE_NAME in "${SERVICE_ARRAY[@]}"; do
            # Trim whitespace
            SERVICE_NAME=$(echo "$SERVICE_NAME" | xargs)

            # Find matching service in service-matrix.yml
            SERVICE_JSON=$(echo "$SERVICES_JSON" | jq -c --arg name "$SERVICE_NAME" '.services[] | select(.["image-name"] == $name)')

            if [ -n "$SERVICE_JSON" ]; then
              echo "✓ Adding ${SERVICE_NAME} to build matrix"
              FILTERED_SERVICES=$(echo "$FILTERED_SERVICES" | jq --argjson item "$SERVICE_JSON" '. += [$item]')
            else
              echo "⚠ Service ${SERVICE_NAME} not found in service-matrix.yml"
            fi
          done

          # Output the matrix
          if [ "$(echo "$FILTERED_SERVICES" | jq 'length')" -eq 0 ]; then
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "has-services=false" >> $GITHUB_OUTPUT
          else
            MATRIX_JSON=$(echo "$FILTERED_SERVICES" | jq -c '{include: .}')
            echo "matrix=${MATRIX_JSON}" >> $GITHUB_OUTPUT
            echo "has-services=true" >> $GITHUB_OUTPUT
            echo "Services to build:"
            echo "$FILTERED_SERVICES" | jq -r '.[] | .["image-name"]'
          fi

      - name: Summary
        run: |
          echo "## Build Matrix Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Inputs" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Tag | \`${{ inputs.version-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ inputs.branch }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Changed Services | \`${{ inputs.changed-services }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Matrix" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Dockerfile | Platform |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------------|----------|" >> $GITHUB_STEP_SUMMARY

          MATRIX='${{ steps.matrix.outputs.matrix }}'
          if [ "${{ steps.matrix.outputs.has-services }}" = "true" ]; then
            echo "$MATRIX" | jq -r '.include[] | "| \(.["image-name"]) | \(.dockerfile) | \(.platforms) |"' >> $GITHUB_STEP_SUMMARY
          else
            echo "| _No services to build_ | - | - |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.matrix.outputs.has-services }}" = "true" ]; then
            SERVICE_COUNT=$(echo "$MATRIX" | jq '.include | length')
            echo "✅ **${SERVICE_COUNT} service(s)** will be built" >> $GITHUB_STEP_SUMMARY
          else
            echo "⏭️ **No services** to build - skipping build job" >> $GITHUB_STEP_SUMMARY
          fi

  build-images:
    name: Build docker
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.has-services == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.prepare-matrix.outputs.matrix) }}
    uses: ./.github/workflows/_build.yml
    permissions:
      packages: write
    with:
      dockerfile: ${{ matrix.dockerfile }}
      image-name: ${{ matrix.image-name }}
      context: ${{ matrix.context }}
      platforms: ${{ matrix.platforms }}
      push: ${{ inputs.branch == 'main' || inputs.branch == 'develop' }}
      cache-key: ${{ inputs.branch }}
      environment: ${{ inputs.environment }}
      version-tag: ${{ inputs.version-tag }}
    secrets: inherit
