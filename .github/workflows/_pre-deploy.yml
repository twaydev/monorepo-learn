name: Pre-Deploy - Verify Railway Service (Reusable)

on:
  workflow_call:
    inputs:
      service:
        description: "Railway service name to verify"
        required: true
        type: string
      environment:
        description: "Target environment"
        required: true
        type: string
    secrets:
      RAILWAY_TOKEN:
        required: true

jobs:
  verify-service:
    name: Verify Service
    runs-on: ubuntu-latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Verify Railway connection
        run: |
          echo "Checking Railway CLI version..."
          railway --version
          echo ""
          echo "Verifying project token is set..."
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: RAILWAY_TOKEN is not set!"
            exit 1
          fi
          echo "RAILWAY_TOKEN is set (length: ${#RAILWAY_TOKEN})"
          echo ""
          echo "Note: Project tokens are scoped to a specific project/environment"
          echo "Service to deploy: ${{ inputs.service }}"

      - name: Summary
        run: |
          echo "## Pre-Deploy Verification Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Ready for deployment âœ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Services must be created in Railway dashboard first." >> $GITHUB_STEP_SUMMARY
          echo "Project tokens can only deploy to existing services." >> $GITHUB_STEP_SUMMARY
