name: CI Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "go-services/**"
      - "php-services/**"
      - "docker/**"
      - ".github/workflows/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "go-services/**"
      - "php-services/**"
      - "docker/**"
      - ".github/workflows/**"
  workflow_dispatch:
    inputs:
      build_all:
        description: "Build all services (ignore change detection)"
        required: false
        type: boolean
        default: true

jobs:
  setup:
    name: Setup Build Configuration
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.config.outputs.environment }}
      version-tag: ${{ steps.config.outputs.version-tag }}
      branch: ${{ steps.config.outputs.branch }}
      changed-services: ${{ steps.changes.outputs.changed-services }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Detect changes
        id: changes
        run: |
          # For manual dispatch with build_all, skip change detection
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ inputs.build_all }}" = "true" ]; then
            echo "changed-services=all" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine base SHA for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
          elif [ "${{ github.event_name }}" = "push" ]; then
            BASE_SHA=${{ github.event.before }}
            # Handle initial commit or force push
            if [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
              echo "Initial commit detected, building all services"
              echo "changed-services=all" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            # workflow_dispatch without build_all
            echo "changed-services=" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANGED_FILES=$(git diff --name-only $BASE_SHA ${{ github.sha }} 2>/dev/null || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files detected"
            echo "changed-services=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""

          # Load services from service-matrix.yml and detect changes dynamically
          SERVICES_FILE=".github/service-matrix.yml"
          if [ ! -f "$SERVICES_FILE" ]; then
            echo "Error: $SERVICES_FILE not found"
            exit 1
          fi

          SERVICES_JSON=$(yq eval -o=json "$SERVICES_FILE")
          CHANGED_SERVICES=""

          # Iterate through services and check for changes
          for row in $(echo "$SERVICES_JSON" | jq -r '.services[] | @base64'); do
            _jq() {
              echo ${row} | base64 --decode | jq -r ${1}
            }

            SERVICE_NAME=$(_jq '.["image-name"]')
            SOURCE_PATH=$(_jq '.["source-path"]')
            DOCKERFILE=$(_jq '.dockerfile')

            # Build regex pattern: source path + dockerfile
            PATTERN="^(${SOURCE_PATH}/|${DOCKERFILE})"

            if echo "$CHANGED_FILES" | grep -qE "$PATTERN"; then
              echo "✓ ${SERVICE_NAME} needs rebuild (changes in ${SOURCE_PATH} or ${DOCKERFILE})"
              CHANGED_SERVICES="${CHANGED_SERVICES}${SERVICE_NAME},"
            else
              echo "○ ${SERVICE_NAME} unchanged"
            fi
          done

          # Remove trailing comma
          CHANGED_SERVICES="${CHANGED_SERVICES%,}"

          echo ""
          echo "Changed services: $CHANGED_SERVICES"
          echo "changed-services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT

      - name: Determine environment and version
        id: config
        run: |
          # Determine branch
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

          # Determine environment and version tag
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            echo "version-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT

          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            BUILD_NUM=$(git rev-list --count HEAD)
            echo "version-tag=v1.0.0-staging.${BUILD_NUM}" >> $GITHUB_OUTPUT

          else
            echo "environment=preview" >> $GITHUB_OUTPUT
            COMMIT_SHA=$(git rev-parse --short HEAD)
            echo "version-tag=dev-${COMMIT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ steps.config.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Tag:** ${{ steps.config.outputs.version-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ steps.config.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Services:** ${{ steps.changes.outputs.changed-services }}" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build Images
    needs: setup
    if: needs.setup.outputs.changed-services != ''
    uses: ./.github/workflows/ci-build.yml
    permissions:
      packages: write
    with:
      environment: ${{ needs.setup.outputs.environment }}
      version-tag: ${{ needs.setup.outputs.version-tag }}
      branch: ${{ needs.setup.outputs.branch }}
      changed-services: ${{ needs.setup.outputs.changed-services }}
    secrets: inherit
